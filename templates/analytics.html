{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-extrabold mb-2 text-primary-accent">Analytics Dashboard</h1>
        <p class="text-gray-700 dark:text-gray-300">Track your energy consumption and savings.</p>
    </div>

    <!-- Analytics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12" id="analytics-stats">
        <!-- Stats cards will be dynamically inserted here -->
    </div>

    <!-- Chart and Controls -->
    <div data-slot="card" class="bg-card text-card-foreground gap-6 rounded-xl border p-6 shadow-sm transition-all flex flex-col">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Power Consumption</h2>
            <div class="flex space-x-2">
                <button id="hourly-btn" class="chart-btn px-4 py-2 rounded-md font-medium text-sm transition-colors active">Hourly</button>
                <button id="daily-btn" class="chart-btn px-4 py-2 rounded-md font-medium text-sm transition-colors">Daily</button>
                <button id="monthly-btn" class="chart-btn px-4 py-2 rounded-md font-medium text-sm transition-colors">Monthly</button>
            </div>
        </div>
        <div class="w-full">
            <canvas id="consumption-chart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const API_BASE_URL = window.location.origin;
    let consumptionChart;

    const createChart = (labels, barData, lineData, label, unit) => {
        const ctx = document.getElementById('consumption-chart').getContext('2d');
        if (consumptionChart) {
            consumptionChart.destroy();
        }
        
        const chartColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-accent-light').trim();
        const chartColorDark = getComputedStyle(document.documentElement).getPropertyValue('--secondary-accent-dark').trim();
        const borderColor = document.documentElement.classList.contains('dark') ? chartColorDark : chartColor;

        consumptionChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [{
                    label: 'Consumption',
                    data: barData,
                    borderColor: borderColor,
                    backgroundColor: borderColor,
                    type: 'bar',
                    order: 2,
                    borderRadius: 5,
                }, {
                    label: 'Trend',
                    data: lineData,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-accent-light').trim(),
                    backgroundColor: 'transparent',
                    type: 'line',
                    order: 1,
                    tension: 0.4,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color-light').trim(),
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted-foreground-light').trim(),
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color-light').trim(),
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted-foreground-light').trim(),
                            callback: function(value) {
                                return value + ` ${unit}`;
                            }
                        }
                    }
                }
            },
        });
    };

    const fetchAnalyticsData = async () => {
        try {
            const response = await fetch('/api/get-analytics');
            if (!response.ok) throw new Error('Failed to fetch analytics data.');
            return await response.json();
        } catch (error) {
            console.error("Error fetching analytics data:", error);
            showNotification('Failed to load analytics data.', 'off');
            return null;
        }
    };

    const updateStatsCards = (stats) => {
        const statsContainer = document.getElementById('analytics-stats');
        statsContainer.innerHTML = `
            <div data-slot="card" class="bg-card text-card-foreground gap-6 rounded-xl border p-6 shadow-sm transition-all flex flex-col items-center">
                <h3 class="text-lg font-semibold text-text-card-foreground">Highest Usage</h3>
                <p class="text-3xl font-bold text-primary-accent">${stats.highest_usage.toFixed(2)} kWh</p>
            </div>
            <div data-slot="card" class="bg-card text-card-foreground gap-6 rounded-xl border p-6 shadow-sm transition-all flex flex-col items-center">
                <h3 class="text-lg font-semibold text-text-card-foreground">Average Usage</h3>
                <p class="text-3xl font-bold text-primary-accent">${stats.average_usage.toFixed(2)} kWh</p>
            </div>
            <div data-slot="card" class="bg-card text-card-foreground gap-6 rounded-xl border p-6 shadow-sm transition-all flex flex-col items-center">
                <h3 class="text-lg font-semibold text-text-card-foreground">Estimated Savings</h3>
                <p class="text-3xl font-bold text-primary-accent">${stats.savings.toFixed(2)} kWh</p>
            </div>
        `;
    };

    const setupChartControls = (data) => {
        const hourlyBtn = document.getElementById('hourly-btn');
        const dailyBtn = document.getElementById('daily-btn');
        const monthlyBtn = document.getElementById('monthly-btn');
        const buttons = [hourlyBtn, dailyBtn, monthlyBtn];

        const setActive = (activeBtn) => {
            buttons.forEach(btn => btn.classList.remove('active'));
            activeBtn.classList.add('active');
        };

        hourlyBtn.addEventListener('click', () => {
            setActive(hourlyBtn);
            createChart(Object.keys(data.hourly), Object.values(data.hourly), Object.values(data.hourly), 'Hourly Consumption', 'kWh');
        });

        dailyBtn.addEventListener('click', () => {
            setActive(dailyBtn);
            createChart(Object.keys(data.daily), Object.values(data.daily), Object.values(data.daily), 'Daily Consumption', 'kWh');
        });

        monthlyBtn.addEventListener('click', () => {
            setActive(monthlyBtn);
            createChart(Object.keys(data.monthly), Object.values(data.monthly), Object.values(data.monthly), 'Monthly Consumption', 'kWh');
        });

        // Set initial chart
        createChart(Object.keys(data.hourly), Object.values(data.hourly), Object.values(data.hourly), 'Hourly Consumption', 'kWh');
    };

    window.onload = async () => {
        const data = await fetchAnalyticsData();
        if (data) {
            updateStatsCards(data.stats);
            setupChartControls(data);
        }
    };
</script>
{% endblock %}
