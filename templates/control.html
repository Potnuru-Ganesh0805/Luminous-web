{% extends "base.html" %}

{% block title %}Control Panel{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-extrabold mb-2 text-primary-accent">Relay Control Panel</h1>
        <p class="text-gray-700 dark:text-gray-300">Manage your rooms and appliances.</p>
    </div>

    <!-- Main View: Rooms -->
    <div id="rooms-view" class="transition-transform duration-500">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-text-card-foreground">Rooms</h2>
            <button id="add-room-btn" class="bg-secondary-accent text-white px-4 py-2 rounded-md font-semibold hover:bg-opacity-80 transition-colors">
                <i class="fas fa-plus-circle mr-2"></i>Add Room
            </button>
        </div>
        <div id="room-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Room cards will be dynamically inserted here -->
        </div>
    </div>
    
    <!-- Appliance View -->
    <div id="appliances-view" class="hidden transition-transform duration-500">
        <div class="flex items-center justify-between mb-4">
            <button id="back-to-rooms-btn" class="bg-gray-400 text-white px-4 py-2 rounded-md font-semibold hover:bg-gray-500 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Rooms
            </button>
            <h2 class="text-3xl font-bold text-text-card-foreground flex-grow text-center" id="appliances-heading"></h2>
            
        </div>
        <div class="flex justify-center space-x-4 mb-4">
            <button id="open-webcam-btn" class="bg-secondary-accent text-white px-4 py-2 rounded-md font-semibold hover:bg-opacity-80 transition-colors">
                <i class="fas fa-camera mr-2"></i>Open Webcam
            </button>
            <button id="start-monitoring-btn" class="bg-primary-accent text-white px-4 py-2 rounded-md font-semibold hover:bg-opacity-80 transition-colors">
                <i class="fas fa-eye mr-2"></i>Start Monitoring
            </button>
        </div>
        <div id="appliance-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Appliance cards will be dynamically inserted here -->
        </div>
        <button id="add-appliance-btn" class="fixed bottom-8 right-8 bg-secondary-accent text-white px-6 py-3 rounded-full font-semibold shadow-lg hover:bg-opacity-80 transition-colors">
            <i class="fas fa-plus mr-2"></i> Add Appliance
        </button>
    </div>

    <!-- Modals for adding rooms and appliances -->
    <div id="add-room-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-gray-800 dark:bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-card p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-xl font-bold mb-4 text-text-card-foreground">Add New Room</h3>
            <form id="add-room-form">
                <label for="new-room-name" class="block text-text-card-foreground mb-2">Room Name:</label>
                <input type="text" id="new-room-name" name="name" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:outline-none" required>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-room-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-secondary-accent text-white rounded-lg hover:bg-opacity-80 transition-colors">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-appliance-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-gray-800 dark:bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-card p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-xl font-bold mb-4 text-text-card-foreground">Add New Appliance</h3>
            <form id="add-appliance-form">
                <label for="new-appliance-name" class="block text-text-card-foreground mb-2">Appliance Name:</label>
                <input type="text" id="new-appliance-name" name="name" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:outline-none" required>
                <label for="new-appliance-relay" class="block text-text-card-foreground mb-2 mt-4">Relay Number (1-4):</label>
                <input type="number" id="new-appliance-relay" name="relay" min="1" max="4" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:outline-none" required>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-appliance-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-secondary-accent text-white rounded-lg hover:bg-opacity-80 transition-colors">Add</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="settings-appliance-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-gray-800 dark:bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-card p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-xl font-bold mb-4 text-text-card-foreground">Edit Appliance Settings</h3>
            <form id="settings-appliance-form">
                <input type="hidden" id="edit-room-id">
                <input type="hidden" id="edit-appliance-id">
                <label for="edit-appliance-name" class="block text-text-card-foreground mb-2">Appliance Name:</label>
                <input type="text" id="edit-appliance-name" name="name" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:outline-none" required>
                
                <div class="mt-4">
                    <label for="edit-room-selector" class="block text-text-card-foreground mb-2">Change Room:</label>
                    <select id="edit-room-selector" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:outline-none">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <div class="mt-4">
                    <div class="advanced-settings-toggle cursor-pointer font-semibold text-secondary-accent hover:underline">
                        Advanced Settings <i class="fas fa-caret-down"></i>
                    </div>
                    <div id="advanced-settings" class="hidden pt-2 border-t mt-2">
                        <label for="edit-appliance-relay" class="block text-text-card-foreground mb-2">Relay Number (1-4):</label>
                        <input type="number" id="edit-appliance-relay" name="relay" min="1" max="4" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:outline-none" required>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-settings-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-secondary-accent text-white rounded-lg hover:bg-opacity-80 transition-colors">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timer Modal -->
    <div id="timer-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-gray-800 dark:bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-card p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-xl font-bold mb-4 text-text-card-foreground">Set Timer</h3>
            <form id="timer-form">
                <input type="hidden" id="timer-room-id">
                <input type="hidden" id="timer-appliance-id">
                <label for="timer-duration" class="block text-text-card-foreground mb-2">Duration (minutes):</label>
                <input type="number" id="timer-duration" min="1" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:outline-none" required>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-timer-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-secondary-accent text-white rounded-lg hover:bg-opacity-80 transition-colors">Set Timer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
    let currentRoomId = null;
    let timerIntervals = {};

    const fetchRoomsAndAppliances = async () => {
        console.log("Fetching rooms and appliances...");
        try {
            const response = await fetch('/api/get-rooms-and-appliances');
            if (!response.ok) throw new Error('Failed to fetch rooms and appliances');
            const rooms = await response.json();
            console.log("Rooms data received:", rooms);
            renderRooms(rooms);
            if (currentRoomId) {
                const room = rooms.find(r => r.id === currentRoomId);
                if (room) {
                    renderAppliances(room.appliances, room.name, rooms);
                } else {
                    currentRoomId = null;
                    document.getElementById('rooms-view').classList.remove('hidden');
                    document.getElementById('appliances-view').classList.add('hidden');
                }
            }
        } catch (error) {
            console.error(error);
            showNotification('Failed to load data.', 'off');
        }
    };
    
    // Save new room order to the backend
    const saveNewRoomOrder = async (newOrder) => {
        try {
            await fetch('/api/save-room-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order: newOrder })
            });
        } catch (error) {
            console.error("Failed to save new room order:", error);
        }
    };
    
    const saveNewApplianceOrder = async (roomId, newOrder) => {
        try {
            await fetch('/api/save-appliance-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId, order: newOrder })
            });
        } catch (error) {
            console.error("Failed to save new appliance order:", error);
        }
    };
    
    const renderRooms = (rooms) => {
        console.log("Rendering rooms with data:", rooms);
        const container = document.getElementById('room-container');
        container.innerHTML = '';
        if (rooms.length > 0) {
            rooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.setAttribute('data-slot', 'card');
                roomCard.setAttribute('data-id', room.id);
                roomCard.className = "bg-card text-card-foreground rounded-xl border p-6 shadow-sm transition-all cursor-pointer hover:scale-105 transform";
                roomCard.onclick = () => {
                    currentRoomId = room.id;
                    renderAppliances(room.appliances, room.name, rooms);
                };
                roomCard.innerHTML = `<h3 class="text-xl font-bold">${room.name}</h3><p class="text-gray-500">${room.appliances.length} Appliances</p>`;
                container.appendChild(roomCard);
            });
            // Make rooms sortable
            new Sortable(container, {
                animation: 150,
                ghostClass: 'bg-gray-300 dark:bg-gray-600',
                onEnd: async (evt) => {
                    const newOrder = Array.from(container.children).map(child => child.dataset.id);
                    await saveNewRoomOrder(newOrder);
                }
            });
        } else {
            container.innerHTML = `<p class="text-center text-gray-500">No rooms added yet. Click "Add Room" to get started!</p>`;
        }
    };

    const updateTimerDisplay = (card, appliance) => {
        const timerElement = card.querySelector('.timer-display');
        if (!timerElement) return;

        clearInterval(timerIntervals[appliance.id]);

        if (appliance.timer && appliance.state) {
            const update = () => {
                const timeLeft = Math.floor(appliance.timer - Date.now() / 1000);
                if (timeLeft > 0) {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `Timer: ${minutes}m ${seconds}s`;
                } else {
                    timerElement.textContent = `Timer Off`;
                    clearInterval(timerIntervals[appliance.id]);
                }
            };
            update();
            timerIntervals[appliance.id] = setInterval(update, 1000);
        } else {
            timerElement.textContent = '';
        }
    };
    
    const renderAppliances = (appliances, roomName, allRooms) => {
        const container = document.getElementById('appliance-container');
        container.innerHTML = '';
        const appliancesHeading = document.getElementById('appliances-heading');
        if (appliancesHeading) {
            appliancesHeading.textContent = roomName;
        }
        document.getElementById('rooms-view').classList.add('hidden');
        document.getElementById('appliances-view').classList.remove('hidden');

        if (appliances.length > 0) {
            appliances.forEach(appliance => {
                const is_on = appliance.state;
                const is_locked = appliance.locked;
                const applianceCard = document.createElement('div');
                applianceCard.setAttribute('data-slot', 'card');
                applianceCard.setAttribute('data-id', appliance.id);
                applianceCard.className = "bg-card text-card-foreground rounded-xl border py-6 px-6 shadow-sm transition-all flex flex-col items-stretch relative";

                let timerDisplay = '';
                if (appliance.timer) {
                     const timeLeft = Math.floor(appliance.timer - Date.now() / 1000);
                     if (timeLeft > 0) {
                         const minutes = Math.floor(timeLeft / 60);
                         const seconds = timeLeft % 60;
                         timerDisplay = `<span class="absolute top-2 right-2 text-xs font-semibold text-primary-accent">Timer: ${minutes}m ${seconds}s</span>`;
                     }
                }
                
                applianceCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div data-slot="card-title" class="leading-none font-semibold pr-2 flex items-center">
                            <input type="text" value="${appliance.name}" class="appliance-name-input w-full bg-transparent font-medium focus:outline-none focus:border-b focus:border-gray-400 dark:text-gray-200" data-room-id="${currentRoomId}" data-appliance-id="${appliance.id}" onblur="saveApplianceName(this)" disabled>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="p-1 rounded-full hover:bg-muted transition-colors flex-shrink-0" title="Set Manual Override" onclick="toggleLock('${currentRoomId}', '${appliance.id}')">
                                <i id="lock-icon-${appliance.id}" class="h-4 w-4 fas ${is_locked ? 'fa-lock text-red-500' : 'fa-unlock text-gray-400'}"></i>
                            </button>
                            <button class="p-1 rounded-full hover:bg-muted transition-colors flex-shrink-0" title="Set Timer" onclick="openTimerModal('${currentRoomId}', '${appliance.id}')">
                                <i class="h-4 w-4 fas fa-clock text-gray-400"></i>
                            </button>
                            <button class="p-1 rounded-full hover:bg-muted transition-colors flex-shrink-0" title="Appliance Settings" onclick="openApplianceSettings('${currentRoomId}', '${appliance.id}', '${appliance.name}', '${appliance.relay_number}')">
                                <i class="h-4 w-4 fas fa-cog text-gray-400"></i>
                            </button>
                        </div>
                    </div>
                    <div data-slot="card-content" class="flex-grow flex items-center justify-between">
                        <i class="fas fa-lightbulb text-2xl ${is_on ? 'text-primary-accent' : 'text-gray-400 dark:text-gray-600'} transition-colors"></i>
                        <button type="button" role="switch" data-room-id="${currentRoomId}" data-appliance-id="${appliance.id}" data-state="${is_on}" class="toggle-switch-button ${is_on ? 'data-[state=checked]' : 'data-[state=unchecked]'}" ${is_locked ? 'disabled' : ''}>
                            <span data-slot="switch-thumb" class="bg-white pointer-events-none block h-5 w-5 rounded-full ring-0 transition-transform"></span>
                        </button>
                    </div>
                    <span class="timer-display absolute bottom-2 left-2 text-xs font-semibold text-primary-accent"></span>
                `;
                container.appendChild(applianceCard);

                const nameInput = applianceCard.querySelector('.appliance-name-input');
                nameInput.addEventListener('dblclick', () => {
                    if (!is_locked) {
                        nameInput.disabled = false;
                        nameInput.focus();
                    }
                });
                nameInput.addEventListener('blur', (e) => saveApplianceName(e.target));
                nameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur();
                    }
                });

                const toggleBtn = applianceCard.querySelector('.toggle-switch-button');
                toggleBtn.onclick = () => {
                    if (!is_locked) {
                        const newState = !is_on;
                        sendApplianceState(currentRoomId, appliance.id, newState);
                    }
                };
                 updateTimerDisplay(applianceCard, appliance);
            });
            new Sortable(container, {
                animation: 150,
                ghostClass: 'bg-gray-300 dark:bg-gray-600',
                onEnd: async (evt) => {
                    const newOrder = Array.from(container.children).map(child => child.dataset.id);
                    await saveNewApplianceOrder(currentRoomId, newOrder);
                }
            });
        } else {
            container.innerHTML = `<p class="text-center text-gray-500">No appliances in this room yet. Click "Add Appliance" to get started!</p>`;
        }
    };
    
    // API Callbacks
    const sendApplianceState = async (roomId, applianceId, state) => {
        try {
            const response = await fetch('/api/set-appliance-state', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId, appliance_id: applianceId, state: state })
            });
            const result = await response.json();
            if (response.ok) {
                showNotification(`Appliance state changed to ${state ? 'ON' : 'OFF'}.`, state ? 'on' : 'off');
                fetchRoomsAndAppliances();
            } else {
                showNotification(`Error: ${result.message}`, 'off');
            }
        } catch (error) {
            console.error(error);
            showNotification('Failed to send command.', 'off');
        }
    };

    const saveApplianceName = async (inputElement) => {
        const roomId = currentRoomId;
        const applianceId = inputElement.dataset.applianceId;
        const newName = inputElement.value;

        if (newName === "") {
            inputElement.value = "Unnamed Appliance";
            showNotification("Appliance name cannot be empty.", "off");
            return;
        }

        try {
            const response = await fetch('/api/set-appliance-name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId, appliance_id: applianceId, name: newName })
            });
            const result = await response.json();
            if (response.ok) {
                showNotification(`Appliance name updated to "${newName}".`, 'on');
            } else {
                showNotification(`Error: ${result.message}`, 'off');
            }
        } catch (error) {
            console.error(error);
            showNotification('Failed to update appliance name.', 'off');
        } finally {
            inputElement.disabled = true;
        }
    };

    const toggleLock = async (roomId, applianceId) => {
        try {
            const response = await fetch('/api/get-rooms-and-appliances');
            const rooms = await response.json();
            const appliance = rooms.find(r => r.id === roomId).appliances.find(a => a.id === applianceId);
            const newState = !appliance.locked;

            const lockResponse = await fetch('/api/set-lock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId, appliance_id: applianceId, locked: newState })
            });
            const result = await lockResponse.json();
            if (lockResponse.ok) {
                showNotification(`Appliance is now ${newState ? 'locked' : 'unlocked'}.`, 'on');
                fetchRoomsAndAppliances();
            } else {
                showNotification(`Error: ${result.message}`, 'off');
            }
        } catch (error) {
            console.error(error);
            showNotification('Failed to update lock state.', 'off');
        }
    };
    
    // Timer Functionality
    const setTimer = async (roomId, applianceId, durationMinutes) => {
        try {
            const response = await fetch('/api/set-timer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId, appliance_id: applianceId, duration_minutes: durationMinutes })
            });
            const result = await response.json();
            if (response.ok) {
                showNotification(`Timer set for ${durationMinutes} minutes.`, 'on');
                fetchRoomsAndAppliances();
            } else {
                showNotification(`Error: ${result.message}`, 'off');
            }
        } catch (error) {
            console.error(error);
            showNotification('Failed to set timer.', 'off');
        }
    };


    // Modal and Form Handlers
    document.getElementById('add-room-btn').addEventListener('click', () => {
        document.getElementById('add-room-modal').classList.remove('hidden');
    });
    document.getElementById('cancel-room-btn').addEventListener('click', () => {
        document.getElementById('add-room-modal').classList.add('hidden');
    });
    document.getElementById('add-room-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const roomName = document.getElementById('new-room-name').value;
        const response = await fetch('/api/add-room', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: roomName })
        });
        const result = await response.json();
        if (response.ok) {
            document.getElementById('add-room-modal').classList.add('hidden');
            fetchRoomsAndAppliances();
            showNotification('Room added successfully!', 'on');
        } else {
            showNotification(`Error: ${result.message}`, 'off');
        }
    });

    document.getElementById('add-appliance-btn').addEventListener('click', () => {
        document.getElementById('add-appliance-modal').classList.remove('hidden');
    });
    document.getElementById('cancel-appliance-btn').addEventListener('click', () => {
        document.getElementById('add-appliance-modal').classList.add('hidden');
    });
    document.getElementById('add-appliance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const applianceName = document.getElementById('new-appliance-name').value;
        const relayNumber = document.getElementById('new-appliance-relay').value;
        const response = await fetch('/api/add-appliance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room_id: currentRoomId, name: applianceName, relay_number: relayNumber })
        });
        const result = await response.json();
        if (response.ok) {
            document.getElementById('add-appliance-modal').classList.add('hidden');
            fetchRoomsAndAppliances();
            showNotification('Appliance added successfully!', 'on');
        } else {
            showNotification(`Error: ${result.message}`, 'off');
        }
    });

    const openApplianceSettings = async (roomId, applianceId) => {
        try {
            const response = await fetch('/api/get-rooms-and-appliances');
            const rooms = await response.json();
            const appliance = rooms.find(r => r.id === roomId).appliances.find(a => a.id === applianceId);
            
            document.getElementById('edit-room-id').value = roomId;
            document.getElementById('edit-appliance-id').value = applianceId;
            document.getElementById('edit-appliance-name').value = appliance.name;
            
            const roomSelector = document.getElementById('edit-room-selector');
            roomSelector.innerHTML = '';
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.id;
                option.textContent = room.name;
                if (room.id === roomId) {
                    option.selected = true;
                }
                roomSelector.appendChild(option);
            });
            
            const advancedSettingsToggle = document.querySelector('.advanced-settings-toggle');
            const advancedSettings = document.getElementById('advanced-settings');
            advancedSettingsToggle.onclick = () => {
                advancedSettings.classList.toggle('hidden');
                document.getElementById('edit-appliance-relay').value = appliance.relay_number;
            };

            document.getElementById('settings-appliance-modal').classList.remove('hidden');
        } catch (error) {
            console.error(error);
            showNotification('Failed to open settings.', 'off');
        }
    };
    
    document.getElementById('cancel-settings-btn').addEventListener('click', () => {
        document.getElementById('settings-appliance-modal').classList.add('hidden');
    });

    document.getElementById('settings-appliance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const roomId = document.getElementById('edit-room-id').value;
        const applianceId = document.getElementById('edit-appliance-id').value;
        const newName = document.getElementById('edit-appliance-name').value;
        const newRelay = document.getElementById('edit-appliance-relay').value;
        const newRoomId = document.getElementById('edit-room-selector').value;
        
        try {
            const response = await fetch('/api/update-appliance-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId, appliance_id: applianceId, name: newName, relay_number: newRelay, new_room_id: newRoomId })
            });
            const result = await response.json();
            if (response.ok) {
                showNotification('Appliance settings updated!', 'on');
                document.getElementById('settings-appliance-modal').classList.add('hidden');
                fetchRoomsAndAppliances();
            } else {
                showNotification(`Error: ${result.message}`, 'off');
            }
        } catch (error) {
            console.error(error);
            showNotification('Failed to save settings.', 'off');
        }
    });
    
    const openTimerModal = async (roomId, applianceId) => {
        document.getElementById('timer-room-id').value = roomId;
        document.getElementById('timer-appliance-id').value = applianceId;
        document.getElementById('timer-modal').classList.remove('hidden');
    };
    
    document.getElementById('cancel-timer-btn').addEventListener('click', () => {
        document.getElementById('timer-modal').classList.add('hidden');
    });

    document.getElementById('timer-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const roomId = document.getElementById('timer-room-id').value;
        const applianceId = document.getElementById('timer-appliance-id').value;
        const durationMinutes = document.getElementById('timer-duration').value;
        
        await setTimer(roomId, applianceId, durationMinutes);
        document.getElementById('timer-modal').classList.add('hidden');
    });

    const saveNewRoomOrder = async (newOrder) => {
        try {
            await fetch('/api/save-room-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order: newOrder })
            });
        } catch (error) {
            console.error("Failed to save new room order:", error);
        }
    };
    
    const saveNewApplianceOrder = async (roomId, newOrder) => {
        try {
            await fetch('/api/save-appliance-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId, order: newOrder })
            });
        } catch (error) {
            console.error("Failed to save new appliance order:", error);
        }
    };

    document.getElementById('back-to-rooms-btn').addEventListener('click', () => {
        currentRoomId = null;
        document.getElementById('rooms-view').classList.remove('hidden');
        document.getElementById('appliances-view').classList.add('hidden');
    });
    
    // Placeholder function for the new buttons
    const handleWebcam = () => showNotification("Opening webcam...", 'on');
    const handleMonitoring = () => showNotification("Starting AI monitoring...", 'on');
    document.getElementById('open-webcam-btn').addEventListener('click', handleWebcam);
    document.getElementById('start-monitoring-btn').addEventListener('click', handleMonitoring);

    window.onload = () => {
        fetchRoomsAndAppliances();
    };
</script>
{% endblock %}
