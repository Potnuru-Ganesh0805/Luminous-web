{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-extrabold mb-2 text-blue-500">User Settings</h1>
        <p class="text-gray-500 dark:text-gray-400">Manage your profile and app preferences.</p>
    </div>

    <!-- User Profile Card -->
    <div data-slot="card" class="bg-card text-card-foreground rounded-xl border p-8 shadow-sm transition-all max-w-2xl mx-auto mb-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">User Profile</h2>
        <form id="user-settings-form" class="space-y-6">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                <input type="email" id="email" name="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>
            <div>
                <label for="mobile" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mobile</label>
                <input type="tel" id="mobile" name="mobile" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>
            <div>
                <label for="channel" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Communication Channel</label>
                <select id="channel" name="channel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                    <option value="email">Email</option>
                    <option value="mobile">Mobile (SMS)</option>
                </select>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Save Changes</button>
        </form>
    </div>

    <!-- Theme Settings Card -->
    <div data-slot="card" class="bg-card text-card-foreground rounded-xl border p-8 shadow-sm transition-all max-w-2xl mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">Theme</h2>
        <div class="theme-dropdown relative">
            <select id="theme-selector" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="system">System</option>
            </select>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = window.location.origin;

    const fetchUserSettings = async () => {
        try {
            const response = await fetch('/api/get-user-settings');
            if (!response.ok) throw new Error('Failed to fetch user settings.');
            const settings = await response.json();
            document.getElementById('name').value = settings.name;
            document.getElementById('email').value = settings.email;
            document.getElementById('mobile').value = settings.mobile;
            document.getElementById('channel').value = settings.channel;
            
            // Set the theme selector
            document.getElementById('theme-selector').value = settings.theme;
            window.applyTheme(settings.theme); // Apply theme on load
            
        } catch (error) {
            console.error("Error fetching user settings:", error);
            showNotification('Failed to load user settings.', 'off');
        }
    };

    const saveUserSettings = async (event) => {
        event.preventDefault();
        const settings = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            mobile: document.getElementById('mobile').value,
            channel: document.getElementById('channel').value,
            theme: document.getElementById('theme-selector').value
        };

        try {
            const response = await fetch('/api/set-user-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            showNotification('Settings saved successfully.', 'on');
        } catch (error) {
            console.error("Error saving settings:", error);
            showNotification(`Error: ${error.message}`, 'off');
        }
    };

    window.onload = () => {
        fetchUserSettings();
        document.getElementById('user-settings-form').addEventListener('submit', saveUserSettings);
        
        // Add event listener for the theme selector dropdown
        document.getElementById('theme-selector').addEventListener('change', (event) => {
            window.applyTheme(event.target.value);
            // Also save the theme to the backend
            saveUserSettings(new Event('submit'));
        });
    };
</script>
{% endblock %}
